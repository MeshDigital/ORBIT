<Page x:Class="SLSKDONET.Views.DownloadsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:viewmodels="clr-namespace:SLSKDONET.ViewModels"
      mc:Ignorable="d" 
      d:DesignHeight="600" d:DesignWidth="1000"
      Title="DownloadsPage">

    <Grid Background="#1E1E1E">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header / Summary -->
        <Border Grid.Row="0" Background="#252526" BorderBrush="#333" BorderThickness="0,0,0,1" Padding="20">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="ðŸŒ Global Network Activity" FontSize="20" FontWeight="Bold" Foreground="White" VerticalAlignment="Center" Margin="0,0,20,0"/>
                
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding SuccessfulCount, StringFormat='âœ… {0} Done'}" Foreground="#4CAF50" FontSize="14" Margin="0,0,15,0"/>
                    <TextBlock Text="{Binding FailedCount, StringFormat='âŒ {0} Failed'}" Foreground="#F44336" FontSize="14" Margin="0,0,15,0"/>
                    <TextBlock Text="{Binding TodoCount, StringFormat='â³ {0} Active'}" Foreground="#2196F3" FontSize="14"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Global Read-Only Grid -->
        <DataGrid Grid.Row="1" 
                  ItemsSource="{Binding AllGlobalTracks, Source={x:Static Application.Current}, Path=MainWindow.DataContext.DownloadManager}" 
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  Background="Transparent"
                  RowBackground="#1E1E1E"
                  Foreground="#CCCCCC"
                  GridLinesVisibility="Horizontal"
                  HorizontalGridLinesBrush="#333"
                  BorderThickness="0">
             <!-- Note: Binding path above is a bit hacky for XAML-only access. 
                  Ideally MainViewModel exposes this directly or we inject DownloadManager into DownloadsViewModel. 
                  For now, we'll assume MainViewModel isn't directly the DataContext here if it's transient, 
                  BUT DownloadsPage is usually navigated from MainViewModel context. 
                  Let's check code-behind/injection. If it's transient, it might need its own VM.
                  Correction: I will implement a simpler binding assuming DataContext is MainViewModel or similar. -->
             
            <DataGrid.Resources>
                <Style TargetType="DataGridColumnHeader">
                    <Setter Property="Background" Value="#2D2D2D"/>
                    <Setter Property="Foreground" Value="#A0A0A0"/>
                    <Setter Property="Padding" Value="10,8"/>
                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                    <Setter Property="BorderBrush" Value="#404040"/>
                </Style>
                <Style TargetType="DataGridCell">
                    <Setter Property="Padding" Value="8,4"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="DataGridCell">
                                <Border Padding="{TemplateBinding Padding}" 
                                        Background="{TemplateBinding Background}" 
                                        BorderBrush="Transparent" 
                                        BorderThickness="0">
                                    <ContentPresenter VerticalAlignment="Center" />
                                </Border>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </DataGrid.Resources>

            <DataGrid.Columns>
                <DataGridTextColumn Header="Global ID" Binding="{Binding GlobalId}" Width="80" Foreground="#666"/>
                <DataGridTextColumn Header="State" Binding="{Binding State}" Width="100"/>
                
                <DataGridTemplateColumn Header="Artist - Title" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                         <DataTemplate>
                             <TextBlock>
                                 <Run Text="{Binding Artist}" FontWeight="Bold" Foreground="White"/>
                                 <Run Text=" - " Foreground="#666"/>
                                 <Run Text="{Binding Title}" Foreground="#DDD"/>
                             </TextBlock>
                         </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTemplateColumn Header="Monitor" Width="150">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Grid>
                                <ProgressBar Value="{Binding Progress, Mode=OneWay}" Maximum="100" Height="4" VerticalAlignment="Center" Background="#333" Foreground="{Binding StatusColor}"/>
                                <TextBlock Text="{Binding ErrorMessage}" Foreground="#F44336" FontSize="10" TextTrimming="CharacterEllipsis" VerticalAlignment="Bottom"/>
                                <TextBlock Text="{Binding CurrentSpeed}" HorizontalAlignment="Right" FontSize="10" Foreground="#AAA" VerticalAlignment="Top"/>
                            </Grid>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Actions Column -->
                <DataGridTemplateColumn Header="Actions" Width="140">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <!-- Pause -->
                                <Button Content="â¸" Command="{Binding PauseCommand}" 
                                        Visibility="{Binding CanPause, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        ToolTip="Pause" Width="24" Height="24" Background="Transparent" Foreground="#FFC107" BorderThickness="0"/>
                                
                                <!-- Resume -->
                                <Button Content="â–¶" Command="{Binding ResumeCommand}" 
                                        Visibility="{Binding CanResume, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        ToolTip="Resume" Width="24" Height="24" Background="Transparent" Foreground="#4CAF50" BorderThickness="0"/>

                                <!-- Cancel -->
                                <Button Content="â¹" Command="{Binding CancelCommand}" 
                                        Visibility="{Binding CanCancel, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        ToolTip="Cancel" Width="24" Height="24" Background="Transparent" Foreground="#F44336" BorderThickness="0"/>

                                <!-- Recycle / Hard Retry (The Orange Button) -->
                                <Button Content="â™»" Command="{Binding FindNewVersionCommand}" 
                                        Visibility="{Binding CanHardRetry, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        ToolTip="Find New Version" Width="24" Height="24" Background="Transparent" Foreground="#FF9800" BorderThickness="0" FontWeight="Bold"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</Page>