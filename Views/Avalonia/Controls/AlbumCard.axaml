<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:SLSKDONET.ViewModels.Library"
             mc:Ignorable="d" d:DesignWidth="180" d:DesignHeight="260"
             x:Class="SLSKDONET.Views.Avalonia.Controls.AlbumCard"
             x:DataType="vm:AlbumNode">
    
    <!-- Shared Context Menu for entire card -->
    <UserControl.ContextMenu>
        <ContextMenu>
            <MenuItem Header="Analyze Album">
                <MenuItem.Icon>
                    <TextBlock Text="ðŸ”¬"/>
                </MenuItem.Icon>
                <MenuItem Header="Tier 1: Basic (Fast)" Command="{Binding AnalyzeAlbumT1Command}" />
                <MenuItem Header="Tier 2: Detailed" Command="{Binding AnalyzeAlbumT2Command}" />
                <MenuItem Header="Tier 3: Specialized (Deep)" Command="{Binding AnalyzeAlbumT3Command}" />
            </MenuItem>
            <MenuItem Header="Download Album" Command="{Binding DownloadAlbumCommand}">
                <MenuItem.Icon>
                    <TextBlock Text="â¬‡ï¸"/>
                </MenuItem.Icon>
            </MenuItem>
        </ContextMenu>
    </UserControl.ContextMenu>
    
    <Border Width="180" Background="Transparent">
        <StackPanel Spacing="8">
            <!-- Cover Art Container -->
            <Border Width="180" Height="180" CornerRadius="8" ClipToBounds="True" Background="#1A1A1A">
                <Grid>
                    <!-- Fallback Layer (Visible if no artwork) -->
                    <Panel Background="{Binding FallbackBrush}" 
                           IsVisible="{Binding Artwork.Image, Converter={x:Static ObjectConverters.IsNull}}">
                        <TextBlock Text="{Binding FallbackLetter}" 
                                   FontSize="64" FontWeight="Bold" Foreground="White" Opacity="0.5"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Panel>
                    
                    <!-- Artwork Layer -->
                    <Image Source="{Binding Artwork.Image}" Stretch="UniformToFill" 
                           IsVisible="{Binding Artwork.Image, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                           
                    <!-- Hover Play Overlay -->
                    <Grid Name="HoverOverlay" 
                          IsVisible="{Binding IsPointerOver, RelativeSource={RelativeSource AncestorType=UserControl}}"
                          Background="#66000000">
                        <Button Command="{Binding PlayAlbumCommand}"
                                HorizontalAlignment="Center" VerticalAlignment="Center"
                                Width="48" Height="48" CornerRadius="24"
                                Background="#1DB954" BorderThickness="0" Padding="0">
                            <PathIcon Data="{StaticResource icons_play_filled}" Width="20" Height="20" Foreground="White"/>
                        </Button>
                    </Grid>
                    
                    <!-- Loading Skeleton -->
                    <Border Background="#2A2A2A" IsVisible="{Binding IsLoading}">
                        <Border.Styles>
                            <Style Selector="Border">
                                <Style.Animations>
                                    <Animation Duration="0:0:1.5" IterationCount="Infinite">
                                        <KeyFrame Cue="0%">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </KeyFrame>
                                        <KeyFrame Cue="50%">
                                            <Setter Property="Opacity" Value="1.0"/>
                                        </KeyFrame>
                                        <KeyFrame Cue="100%">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </KeyFrame>
                                    </Animation>
                                </Style.Animations>
                            </Style>
                        </Border.Styles>
                    </Border>
                </Grid>
            </Border>
            
            <!-- Metadata -->
            <StackPanel Spacing="2">
                <TextBlock Text="{Binding AlbumTitle}" 
                           FontWeight="SemiBold" FontSize="14" Foreground="White"
                           TextTrimming="CharacterEllipsis"/>
                           
                <TextBlock Text="{Binding Artist}" 
                           FontSize="12" Foreground="#A0A0A0"
                           TextTrimming="CharacterEllipsis"/>
                           
                <StackPanel Orientation="Horizontal" Spacing="4" Opacity="0.6">
                    <TextBlock Text="{Binding TrackCount, StringFormat='{}{0} Tracks'}" FontSize="11" Foreground="#808080"/>
                    <TextBlock Text="â€¢" FontSize="11" Foreground="#808080"/>
                    <TextBlock Text="{Binding Progress, StringFormat='{}{0:0}%'}" FontSize="11" Foreground="#808080" IsVisible="{Binding Progress, Converter={x:Static ObjectConverters.NotEqual}, ConverterParameter=0}"/>
                </StackPanel>
            </StackPanel>
        </StackPanel>
    </Border>
</UserControl>
