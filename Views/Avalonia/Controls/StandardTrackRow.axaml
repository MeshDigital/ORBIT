<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:SLSKDONET.ViewModels"
             xmlns:views="clr-namespace:SLSKDONET.Views.Avalonia"
             xmlns:controls="clr-namespace:SLSKDONET.Views.Avalonia.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="60"
             x:Class="SLSKDONET.Views.Avalonia.Controls.StandardTrackRow"
             x:DataType="vm:PlaylistTrackViewModel">
             
    <UserControl.Styles>
        <Style Selector="Button.ActionBtn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style Selector="Button.ActionBtn:hover">
            <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        
        <Style Selector="Button.pending">
            <Setter Property="Opacity" Value="0.5"/>
        </Style>
        
        <!-- Integrity Badge Styles -->
        <Style Selector="Border.IntegrityBadge">
            <Setter Property="CornerRadius" Value="2"/>
            <Setter Property="Padding" Value="4,1"/>
            <Setter Property="Margin" Value="0,0,6,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style Selector="Border.IntegrityBadge.Secure">
            <Setter Property="Background" Value="#2000FF00"/>
            <Setter Property="BorderBrush" Value="#00FF00"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        <Style Selector="Border.IntegrityBadge.Suspect">
            <Setter Property="Background" Value="#20FFD700"/>
            <Setter Property="BorderBrush" Value="#FFD700"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        
        <Style Selector="Border.PrepBadge">
            <Setter Property="CornerRadius" Value="2"/>
            <Setter Property="Padding" Value="4,1"/>
            <Setter Property="Margin" Value="0,0,6,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <!-- Root Styles -->
        <Style Selector="Border.root">
            <Setter Property="Background" Value="{DynamicResource BackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Padding" Value="8,6"/>
        </Style>
        
        <!-- Card Style (Phase 0.7) -->
        <Style Selector=":is(UserControl).card Border.root">
            <Setter Property="Background" Value="#252526"/>
            <Setter Property="BorderBrush" Value="#333"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>

        <!-- Pending Text Style -->
        <Style Selector="TextBlock.pending">
            <Setter Property="FontStyle" Value="Italic"/>
        </Style>
    </UserControl.Styles>

    <Border Classes="root">
        <Panel>
            <!-- Phase 5B: Removed waveform underlay - was visually noisy in list context -->
            
        <!-- Column 0: Art & Health, 1: Artist, 2: Title, 3: BPM/Key, 4: Badges, 5: Actions -->
        <Grid RowDefinitions="Auto" Margin="0,2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="58"/>
                <ColumnDefinition Width="220"/> <!-- Artist -->
                <ColumnDefinition Width="320"/> <!-- Title -->
                <ColumnDefinition Width="100"/> <!-- BPM/Key -->
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <!-- Column 0: Album Art / Status / Health -->
            <Border Grid.Column="0" Width="44" Height="44" Margin="6,4,8,4" CornerRadius="4" ClipToBounds="True" Background="{DynamicResource SurfaceBrush}" VerticalAlignment="Center">
                <Panel>
                    <Image Source="{Binding Artwork.Image}" Stretch="UniformToFill" IsVisible="{Binding Artwork.Image, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                    <PathIcon Data="{StaticResource music_regular}" Foreground="#333" Width="20" Height="20" IsVisible="{Binding Artwork.Image, Converter={x:Static ObjectConverters.IsNull}}"/>
                    <!-- Progress Overlay -->
                    <Arc Width="36" Height="36" StartAngle="-90" SweepAngle="{Binding Progress, Converter={StaticResource PercentageToAngleConverter}}" Stroke="#00BFFF" StrokeThickness="2" IsVisible="{Binding IsActive}" Opacity="0.8"/>
                </Panel>
            </Border>
            
            <!-- Health Bar -->
            <Rectangle Grid.Column="0" Width="3" HorizontalAlignment="Left" Fill="{Binding QualityColor}" RadiusX="1.5" RadiusY="1.5" Margin="2,8">
                <Rectangle.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}"><Binding Path="IsCompleted"/><Binding Path="$parent[views:LibraryPage].DataContext.ViewSettings.ShowQualityBar"/></MultiBinding>
                </Rectangle.IsVisible>
            </Rectangle>

            <!-- Column 1: Artist (Shared) -->
            <Border Grid.Column="1" Padding="8,0" VerticalAlignment="Center">
                <TextBlock Text="{Binding ArtistName}" FontWeight="SemiBold" Foreground="{DynamicResource TextBrush}" FontSize="13" TextTrimming="CharacterEllipsis"/>
            </Border>

            <!-- Column 2: Title (Shared) -->
            <Border Grid.Column="2" Padding="8,0" VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="{Binding TrackTitle}" Foreground="{DynamicResource TextBrush}" FontSize="13" TextTrimming="CharacterEllipsis"/>
                    <TextBlock Text="â¤ï¸" IsVisible="{Binding IsLiked}" FontSize="11" VerticalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- Column 3: BPM & Key (Shared) -->
            <Border Grid.Column="3" Padding="12,0" VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <TextBlock Text="{Binding BPM, StringFormat='{}{0:0}'}" Foreground="#AAA" FontSize="11" Width="32" TextAlignment="Right" VerticalAlignment="Center"/>
                    <Border Background="{Binding ColorBrush}" CornerRadius="4" Padding="4,1" MinWidth="32" VerticalAlignment="Center">
                        <TextBlock Text="{Binding CamelotDisplay}" Foreground="White" FontSize="10" FontWeight="Bold" HorizontalAlignment="Center"/>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Column 4: Badge Tray (Flexible) -->
            <StackPanel Grid.Column="4" Orientation="Horizontal" VerticalAlignment="Center" Spacing="6" Margin="8,0">
                <!-- Curation/Trust -->
                <Border BorderBrush="{Binding CurationColor}" BorderThickness="1" CornerRadius="2" Padding="3,0" IsVisible="{Binding CurationIcon, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding CurationIcon}" FontSize="9" VerticalAlignment="Center"/>
                </Border>
                <!-- Verified -->
                <Border Background="#2000FF00" BorderBrush="#00FF00" BorderThickness="1" CornerRadius="2" Padding="3,0" IsVisible="{Binding IsSecure}">
                    <TextBlock Text="âœ“" FontSize="9" Foreground="#00FF00" FontWeight="Bold"/>
                </Border>
                <!-- Stems -->
                <Border Background="#10E91E63" BorderBrush="#E91E63" BorderThickness="1" CornerRadius="2" Padding="3,0" IsVisible="{Binding HasStems}">
                    <TextBlock Text="ðŸŽ¹" FontSize="9"/>
                </Border>
                <!-- Vibe -->
                <Border Background="{Binding VibeColor}" CornerRadius="10" Padding="8,1" IsVisible="{Binding DetectedSubGenre, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="{Binding DetectedSubGenre}" FontSize="9" Foreground="White" FontWeight="Bold"/>
                </Border>
                <!-- Tech Info (High Contrast) -->
                <TextBlock Text="{Binding TechnicalSummary}" FontSize="10" Foreground="#AAA" VerticalAlignment="Center" Margin="6,0" FontWeight="SemiBold"/>
            </StackPanel>

            <!-- Column 5: Action Hub (Fixed) -->
            <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="2" VerticalAlignment="Center" Margin="0,0,8,0">
                <Button Classes="ActionBtn" Command="{Binding PlayCommand}" IsVisible="{Binding IsCompleted}" ToolTip.Tip="Play"><PathIcon Data="{StaticResource play_circle_regular}" Width="18" Height="18" Foreground="#00BFFF"/></Button>
                <Button Classes="ActionBtn" Command="{Binding RevealFileCommand}" IsVisible="{Binding IsCompleted}" ToolTip.Tip="Open Folder"><PathIcon Data="{StaticResource folder_open_regular}" Width="16" Height="16"/></Button>
                <Button Classes="ActionBtn" Command="{Binding AddToProjectCommand}" IsVisible="{Binding IsCompleted}" ToolTip.Tip="Add to Project"><PathIcon Data="{StaticResource add_circle_regular}" Width="16" Height="16"/></Button>
                <Button Classes="ActionBtn" Command="{Binding PauseCommand}" IsVisible="{Binding IsActive}" ToolTip.Tip="Pause"><PathIcon Data="{StaticResource pause_regular}" Width="14" Height="14"/></Button>
                <Button Classes="ActionBtn" Command="{Binding CancelCommand}" IsVisible="{Binding IsActive}" ToolTip.Tip="Cancel"><PathIcon Data="{StaticResource dismiss_regular}" Width="14" Height="14" Foreground="#FF6666"/></Button>
                <Button Classes="ActionBtn" Command="{Binding RetryCommand}" IsVisible="{Binding IsFailed}"><PathIcon Data="{StaticResource arrow_counterclockwise_regular}" Width="14" Height="14"/></Button>
            </StackPanel>

        </Grid>
        </Panel>
    </Border>
</UserControl>
