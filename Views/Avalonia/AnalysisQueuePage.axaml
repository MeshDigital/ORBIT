<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:SLSKDONET.ViewModels"
             xmlns:conv="clr-namespace:SLSKDONET.Converters"
             xmlns:controls="clr-namespace:SLSKDONET.Views.Avalonia.Controls"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="SLSKDONET.Views.Avalonia.AnalysisQueuePage"
             Background="#1E1E1E" Foreground="White">

    <UserControl.Resources>
        <conv:StatusToColorConverter x:Key="StatusColorConverter"/>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto,*,Auto,Auto">
        <!-- MASTER VIEW: Analysis Queue -->
            <!-- ROW 0: MISSION CONTROL HEADER -->
            <Grid Grid.Row="0" Margin="32,24" ColumnDefinitions="*, Auto">
                <StackPanel Spacing="4">
                    <TextBlock Text="MISSION CONTROL: ANALYSIS ENGINE" FontSize="20" FontWeight="Bold" LetterSpacing="2"/>
                    <TextBlock Text="ORBIT LIVE TELEMETRY SYSTEM" FontSize="11" Foreground="#666" LetterSpacing="3"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
                    <Button Command="{Binding RunBrainTestCommand}" IsEnabled="{Binding !IsTestRunning}"
                            Background="#114EC9B0" BorderBrush="#4EC9B0" BorderThickness="1">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="ðŸ§ " VerticalAlignment="Center"/>
                            <TextBlock Text="BRAIN TEST" FontWeight="Bold" Foreground="#4EC9B0"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding PerformDemoPrepCommand}" IsEnabled="{Binding !IsPrepRunning}"
                            Background="#11FFFFFF" BorderBrush="#33FFFFFF" BorderThickness="1">
                        <TextBlock Text="SCAN LIBRARY" FontWeight="Bold"/>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- ROW 1: ACTIVE THREADS COCKPIT -->
            <Border Grid.Row="1" Margin="32,0,32,16" Background="#11FFFFFF" CornerRadius="12" Padding="20">
                <Grid RowDefinitions="Auto, *">
                    <TextBlock Grid.Row="0" Text="THREAD ACTIVITY &amp; CONFIDENCE" FontSize="12" FontWeight="Bold" Foreground="#888" Margin="0,0,0,15"/>
                    <ItemsControl Grid.Row="1" ItemsSource="{Binding ActiveThreads}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#1A1A1A" Width="280" Height="140" Margin="0,0,12,12" 
                                        BorderBrush="#33FFFFFF" BorderThickness="1" CornerRadius="8">
                                    <Grid RowDefinitions="*, Auto" Margin="15">
                                        <!-- Top: Identity & Radars -->
                                        <Grid Grid.Row="0" ColumnDefinitions="*, Auto, Auto">
                                            <StackPanel Spacing="4" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding ThreadId, StringFormat='CORE {0}'}" FontSize="10" Foreground="#4EC9B0" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding CurrentTrack}" FontSize="12" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding Status}" FontSize="10" Foreground="#666"/>
                                            </StackPanel>
                                            
                                            <!-- Radars -->
                                            <controls:ConfidenceRadar Grid.Column="1" Label="KEY" Value="{Binding KeyConfidence}" Color="#4EC9B0" Width="45" Height="45"/>
                                            <controls:ConfidenceRadar Grid.Column="2" Label="BPM" Value="{Binding BpmConfidence}" Color="#F44336" Width="45" Height="45"/>
                                        </Grid>
                                        
                                        <!-- Bottom: Progress & Stage LEDs -->
                                        <StackPanel Grid.Row="1" Spacing="10">
                                            <ProgressBar Value="{Binding Progress}" Maximum="100" Height="4" Foreground="#4EC9B0" Background="#11FFFFFF"/>
                                            <ItemsControl ItemsSource="{Binding ActiveStages}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Width="8" Height="8" CornerRadius="4" 
                                                                Background="{Binding Color}" Opacity="{Binding Opacity}"
                                                                ToolTip.Tip="{Binding Label}">

                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </Border>

            <!-- ROW 2: ENGINE METRICS (THROUGHPUT) -->
            <Grid Grid.Row="2" Margin="32,0,32,24" ColumnDefinitions="*,*,*,*">
                <Border Grid.Column="0" Background="#11FFFFFF" Margin="0,0,8,0" Padding="20" CornerRadius="8">
                    <StackPanel>
                        <TextBlock Text="THROUGHPUT" FontSize="10" Foreground="#666" LetterSpacing="2"/>
                        <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,5">
                            <TextBlock Text="{Binding TracksPerMinute, StringFormat='{}{0:F1}'}" FontSize="24" FontWeight="Bold"/>
                            <TextBlock Text="TRK / MIN" FontSize="10" VerticalAlignment="Bottom" Margin="0,0,0,4" Foreground="#444"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
                <Border Grid.Column="1" Background="#11FFFFFF" Margin="8,0,8,0" Padding="20" CornerRadius="8">
                    <StackPanel>
                        <TextBlock Text="SESSION PROCESSED" FontSize="10" Foreground="#666" LetterSpacing="2"/>
                        <TextBlock Text="{Binding TotalProcessed}" FontSize="24" FontWeight="Bold" Margin="0,5"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="2" Background="#11FFFFFF" Margin="8,0,8,0" Padding="20" CornerRadius="8">
                    <StackPanel>
                        <TextBlock Text="ESTIMATED COMPLETION" FontSize="10" Foreground="#666" LetterSpacing="2"/>
                        <TextBlock Text="{Binding EstimatedCompletion}" FontSize="24" FontWeight="Bold" Foreground="#4EC9B0" Margin="0,5"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="3" Background="#11FFFFFF" Margin="8,0,0,0" Padding="20" CornerRadius="8">
                    <StackPanel>
                        <TextBlock Text="CPU WATCHDOG" FontSize="10" Foreground="#666" LetterSpacing="2"/>
                        <ToggleSwitch OnContent="NORMAL" OffContent="CONSTRAINED" IsChecked="True" BorderThickness="0" Margin="0,5"/>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- ROW 3: FORENSIC STREAM CONTROL -->
            <Grid Grid.Row="3" Margin="32,0,32,16">
                 <Button Command="{Binding ToggleForensicStreamCommand}" HorizontalAlignment="Stretch" Padding="15,8" Background="#0AFFFFFF">
                    <Grid ColumnDefinitions="Auto, *, Auto">
                        <TextBlock Text="ðŸ” LIVE FORENSIC STREAM" FontSize="11" FontWeight="Bold" Foreground="#4EC9B0" LetterSpacing="1"/>
                        <TextBlock Grid.Column="2" Text="{Binding IsForensicStreamExpanded, Converter={StaticResource ParameterizedBooleanConverter}, ConverterParameter='COLLAPSE|EXPAND'}" FontSize="10" Foreground="#666"/>
                    </Grid>
                 </Button>
            </Grid>

            <!-- Active Jobs (Row 4) - Using * to fill available space -->
            <Grid Grid.Row="4" Margin="32,16,32,0" RowDefinitions="Auto,*">
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="ACTIVE PROCESSING" FontSize="12" FontWeight="Bold" Foreground="#4EC9B0"/>
                    <Button Grid.Column="1" Content="ðŸ§¹ Purge Stuck" 
                            Command="{Binding PurgeStuckJobsCommand}"
                            FontSize="10" Padding="8,2" Classes="accent" Background="Transparent" BorderBrush="#F44336" Foreground="#F44336"/>
                </Grid>
                
                <DataGrid Grid.Row="1" ItemsSource="{Binding ActiveJobs}" AutoGenerateColumns="False" 
                          CanUserResizeColumns="True" Background="#252526" BorderThickness="0" CornerRadius="8"
                          GridLinesVisibility="Horizontal" HeadersVisibility="Column">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="File" Binding="{Binding FileName}" Width="*"/>
                        <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="120"/>
                        <DataGridTextColumn Header="Step" Binding="{Binding Step}" Width="180"/>
                        <DataGridTemplateColumn Header="Telemetry" Width="200">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Grid Margin="12,0">
                                        <!-- Shimmering Waveform Placeholder -->
                                        <Border Height="20" Background="#11FFFFFF" CornerRadius="4" ClipToBounds="True">
                                            <Panel>
                                                <!-- Animated Gradient Shimmer -->
                                                <Rectangle Fill="#224EC9B0" Width="200" HorizontalAlignment="Left"
                                                           Opacity="0.3">
                                                    <Rectangle.RenderTransform>
                                                        <TranslateTransform X="-200"/>
                                                    </Rectangle.RenderTransform>
                                                </Rectangle>

                                                <!-- Fake Waveform Path -->
                                                <Path Data="M0,10 L5,2 L10,18 L15,5 L20,15 L25,0 L30,20 L35,8 L40,12 L45,3 L50,17 L55,5 L60,15 L65,0 L70,20 L75,8 L80,12 L85,3 L90,17 L95,5 L100,15 L105,0 L110,20 L115,8 L120,12 L125,3 L130,17 L135,5 L140,15 L145,0 L150,20 L155,8 L160,12 L165,3 L170,17 L175,5 L180,15 L185,0 L190,20 L195,8 L200,10" 
                                                      Stroke="#4EC9B0" StrokeThickness="1" Stretch="Fill" Opacity="0.6"/>
                                                

                                            </Panel>
                                        </Border>
                                        <TextBlock Text="{Binding ProgressPercent, StringFormat='{}{0}%'}" 
                                                 FontSize="9" FontWeight="Bold" Foreground="White" 
                                                 HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- Splitter (Row 5) -->
            <GridSplitter Grid.Row="5" Background="#333" Height="2" HorizontalAlignment="Stretch" Margin="32,2"/>

            <!-- Completed Jobs (Row 6) - Using * to fill available space -->
            <Grid Grid.Row="6" Margin="32,0,32,0" RowDefinitions="Auto,*">
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                     <TextBlock Text="RECENTLY COMPLETED" FontSize="12" FontWeight="Bold" Foreground="#1DB954"/>
                     <Button Grid.Column="1" Content="Clear All" 
                             Command="{Binding ClearCompletedCommand}"
                             FontSize="10" Padding="8,2" Background="Transparent" Foreground="#888"/>
                </Grid>
               
                <DataGrid Grid.Row="1" ItemsSource="{Binding CompletedJobs}" AutoGenerateColumns="False" 
                          CanUserResizeColumns="True" Background="#252526" BorderThickness="0" CornerRadius="8"
                          GridLinesVisibility="Horizontal" HeadersVisibility="Column">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="File" Binding="{Binding FileName}" Width="*"/>
                        <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="120"/>
                        <DataGridTextColumn Header="Time" Binding="{Binding Age}" Width="100"/>
                        <DataGridTemplateColumn Header="Actions" Width="180">
                             <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <Button ToolTip.Tip="Play"
                                                Command="{Binding $parent[UserControl].DataContext.PlayTrackCommand}" 
                                                CommandParameter="{Binding}"
                                                FontSize="11" Padding="6" Background="Transparent" Foreground="#1DB954">
                                            <PathIcon Data="{StaticResource play_circle_regular}" Width="14" Height="14"/>
                                        </Button>
                                        <Button ToolTip.Tip="Locate File"
                                                Command="{Binding $parent[UserControl].DataContext.LocateTrackCommand}" 
                                                CommandParameter="{Binding}"
                                                FontSize="11" Padding="6" Background="Transparent" Foreground="#4EC9B0">
                                            <PathIcon Data="{StaticResource folder_open_regular}" Width="14" Height="14"/>
                                        </Button>
                                        <Button Content="Inspect" 
                                                Command="{Binding $parent[UserControl].DataContext.InspectTrackCommand}" 
                                                CommandParameter="{Binding}"
                                                FontSize="10" Padding="8,2" Margin="4,0,0,0"
                                                Classes="accent"/>
                                    </StackPanel>
                                </DataTemplate>
                             </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
            
            <!-- Splitter (Row 7) -->
            <GridSplitter Grid.Row="7" Background="#333" Height="2" HorizontalAlignment="Stretch" Margin="32,2"/>

            <!-- Failed Jobs (Row 8) - Fixed height to avoid domination, but resizable via splitter above if rows were star -->
            <!-- Actually, let's make it 150px fixed unless resize -->
            <Grid Grid.Row="8" Margin="32,0,32,16" RowDefinitions="Auto,*">
                 <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                     <TextBlock Text="FAILED / ERRORS" FontSize="12" FontWeight="Bold" Foreground="#F44336"/>
                     <Button Grid.Column="1" Content="Clear All" 
                             Command="{Binding ClearFailedCommand}"
                             FontSize="10" Padding="8,2" Background="Transparent" Foreground="#888"/>
                 </Grid>
                 <DataGrid Grid.Row="1" ItemsSource="{Binding FailedJobs}" AutoGenerateColumns="False" 
                           CanUserResizeColumns="True" Background="#252526" BorderThickness="0" CornerRadius="8"
                           GridLinesVisibility="Horizontal" HeadersVisibility="Column">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="File" Binding="{Binding FileName}" Width="*"/>
                        <DataGridTextColumn Header="Error" Binding="{Binding Error}" Width="2*"/>
                        <DataGridTextColumn Header="Time" Binding="{Binding Age}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>
</UserControl>
