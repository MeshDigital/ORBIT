<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SLSKDONET.ViewModels"
             x:Class="SLSKDONET.Views.Avalonia.DiagnosticsPanel"
             x:DataType="vm:DiagnosticsViewModel">
    
    <UserControl.Styles>
        <Style Selector="TextBlock.pulse">
            <Style.Animations>
                <Animation Duration="0:0:1" IterationCount="Infinite">
                    <KeyFrame KeyTime="0:0:0">
                        <Setter Property="Opacity" Value="1.0"/>
                    </KeyFrame>
                    <KeyFrame KeyTime="0:0:0.5">
                        <Setter Property="Opacity" Value="0.4"/>
                    </KeyFrame>
                    <KeyFrame KeyTime="0:0:1">
                        <Setter Property="Opacity" Value="1.0"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
        
        <Style Selector="Border.strobe">
            <Style.Animations>
                <Animation Duration="0:0:0.8" IterationCount="Infinite">
                    <KeyFrame KeyTime="0:0:0">
                        <Setter Property="BoxShadow" Value="0 0 0 0 #00D4FF"/>
                    </KeyFrame>
                    <KeyFrame KeyTime="0:0:0.4">
                        <Setter Property="BoxShadow" Value="0 0 15 2 #00D4FF"/>
                    </KeyFrame>
                    <KeyFrame KeyTime="0:0:0.8">
                        <Setter Property="BoxShadow" Value="0 0 0 0 #00D4FF"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </UserControl.Styles>

    <Border Background="#0D1B2A" CornerRadius="12" Padding="20" MinWidth="500"
            Classes.strobe="{Binding IsRunning}">
        <Grid RowDefinitions="Auto, Auto, *, Auto">
            
            <!-- HEADER -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto, *, Auto" Margin="0,0,0,20">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                    <Path Data="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" 
                          Stroke="#00D4FF" StrokeThickness="2" Width="24" Height="24"/>
                    <TextBlock Text="DIAGNOSTICS &amp; TELEMETRY" 
                               FontSize="18" FontWeight="ExtraBold" Foreground="#00D4FF"/>
                </StackPanel>
                
                <TextBlock Grid.Column="1" Text="{Binding CurrentPhase}" 
                           Classes.pulse="{Binding IsRunning}"
                           HorizontalAlignment="Center" VerticalAlignment="Center"
                           FontSize="12" Foreground="#778DA9" FontWeight="Bold"/>
                
                <Button Grid.Column="2" Content="âœ•" Command="{Binding ClosePanel}"
                        Background="Transparent" Foreground="#778DA9" FontSize="16"
                        Padding="8,4" CornerRadius="4"/>
            </Grid>
            
            <!-- FPS GAUGE SECTION -->
            <Border Grid.Row="1" Background="#1B263B" CornerRadius="8" Padding="20" Margin="0,0,0,15">
                <Grid ColumnDefinitions="Auto, *">
                    <!-- Circular FPS Gauge (Simplified Arc) -->
                    <Grid Grid.Column="0" Width="120" Height="120" Margin="0,0,20,0">
                        <Ellipse Width="110" Height="110" Stroke="#415A77" StrokeThickness="8" 
                                 HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <Ellipse Width="110" Height="110" Stroke="{Binding FpsColor}" StrokeThickness="8"
                                 StrokeDashArray="2,1" StrokeDashOffset="{Binding FpsGaugeAngle}"
                                 HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="{Binding CurrentFps, StringFormat='{}{0:F0}'}" 
                                       FontSize="32" FontWeight="ExtraBold" Foreground="White"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="FPS" FontSize="12" Foreground="#778DA9"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                    
                    <!-- Metrics Summary -->
                    <StackPanel Grid.Column="1" Spacing="8" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Status}" FontSize="14" FontWeight="Bold" 
                                   Foreground="{Binding FpsColor}"/>
                        
                        <Grid ColumnDefinitions="Auto, *, Auto" IsVisible="{Binding TestResults, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <TextBlock Grid.Column="0" Text="Avg FPS:" Foreground="#778DA9" FontSize="11"/>
                            <TextBlock Grid.Column="2" Text="{Binding TestResults.AverageFps, StringFormat='{}{0:F1}'}" 
                                       Foreground="White" FontSize="11" FontWeight="Bold"/>
                        </Grid>
                        <Grid ColumnDefinitions="Auto, *, Auto" IsVisible="{Binding TestResults, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <TextBlock Grid.Column="0" Text="Min FPS:" Foreground="#778DA9" FontSize="11"/>
                            <TextBlock Grid.Column="2" Text="{Binding TestResults.MinFps, StringFormat='{}{0:F1}'}" 
                                       Foreground="White" FontSize="11"/>
                        </Grid>
                        <Grid ColumnDefinitions="Auto, *, Auto" IsVisible="{Binding TestResults, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <TextBlock Grid.Column="0" Text="Jitter:" Foreground="#778DA9" FontSize="11"/>
                            <TextBlock Grid.Column="2" Text="{Binding TestResults.JitterMs, StringFormat='{}{0:F2} ms'}" 
                                       Foreground="White" FontSize="11"/>
                        </Grid>
                        <Grid ColumnDefinitions="Auto, *, Auto" IsVisible="{Binding TestResults, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <TextBlock Grid.Column="0" Text="CPU Peak:" Foreground="#778DA9" FontSize="11"/>
                            <TextBlock Grid.Column="2" Text="{Binding TestResults.MaxCpuPercent, StringFormat='{}{0:F1}%'}" 
                                       Foreground="White" FontSize="11"/>
                        </Grid>
                        <Grid ColumnDefinitions="Auto, *, Auto" IsVisible="{Binding TestResults, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <TextBlock Grid.Column="0" Text="Dropped:" Foreground="#778DA9" FontSize="11"/>
                            <TextBlock Grid.Column="2" Text="{Binding TestResults.DroppedFrames}" 
                                       Foreground="#FFAA00" FontSize="11" FontWeight="Bold"/>
                        </Grid>
                    </StackPanel>
                </Grid>
            </Border>
            
            <!-- LIVE LOG -->
            <Border Grid.Row="2" Background="#1B263B" CornerRadius="8" Padding="10">
                <ScrollViewer>
                    <ItemsControl ItemsSource="{Binding LogEntries}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" FontSize="11" Foreground="#E0E1DD" 
                                           FontFamily="Consolas" Margin="0,2"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
            
            <!-- ACTION BUTTONS -->
            <StackPanel Grid.Row="3" Orientation="Horizontal" Spacing="10" Margin="0,15,0,0" HorizontalAlignment="Right">
                <Button Content="Cancel" Command="{Binding CancelTestCommand}"
                        IsVisible="{Binding IsRunning}"
                        Background="#415A77" Foreground="White" Padding="15,8" CornerRadius="4"/>
                
                <Button Content="ðŸŒ‰ GENRE BRIDGE" Command="{Binding RunCreativeTestCommand}"
                        IsEnabled="{Binding !IsRunning}"
                        Background="#FF6B35" Foreground="White" FontWeight="Bold"
                        Padding="15,10" CornerRadius="6"
                        ToolTip.Tip="Test Mentor AI with 100â†’128 BPM transition"/>
                        
                <Button Content="ðŸš€ START REDLINE TEST" Command="{Binding RunStressTestCommand}"
                        IsEnabled="{Binding !IsRunning}"
                        Background="#00D4FF" Foreground="#0D1B2A" FontWeight="Bold"
                        Padding="20,10" CornerRadius="6"/>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
