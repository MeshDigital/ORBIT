<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:SLSKDONET.ViewModels"
             xmlns:controls="clr-namespace:SLSKDONET.Views.Avalonia.Controls"
             mc:Ignorable="d" d:DesignWidth="1400" d:DesignHeight="900"
             x:Class="SLSKDONET.Views.Avalonia.ForensicUnifiedView"
             Background="#0A0A0A">

    <Grid RowDefinitions="Auto, *, 350">
        <!-- 1. Header: Dual Deck Identity -->
        <Border Grid.Row="0" Background="#111" Padding="15">
            <Grid ColumnDefinitions="*, 60, *">
            <!-- Deck A Metadata -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="15">
                <Border Background="#FF4081" CornerRadius="4" Padding="10,4" VerticalAlignment="Center">
                    <TextBlock Text="{Binding DeckA.CamelotKey}" FontSize="20" FontWeight="Bold" Foreground="White"/>
                </Border>
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="{Binding DeckA.DisplayName}" FontSize="20" Foreground="White" FontWeight="SemiBold"/>
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBlock Text="{Binding DeckA.BpmValue, StringFormat='{}{0:F1} BPM'}" FontSize="12" Foreground="#4EC9B0"/>
                        <TextBlock Text="DECK A" FontSize="10" Foreground="#666" FontWeight="Bold" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>

            <StackPanel Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="ORBIT" FontSize="12" FontWeight="Black" Foreground="#333" HorizontalAlignment="Center"/>
                <Separator Width="1" Background="#222" Height="20"/>
            </StackPanel>

            <!-- Deck B Metadata -->
            <StackPanel Grid.Column="2" HorizontalAlignment="Right" Orientation="Horizontal" Spacing="15">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Right">
                    <TextBlock Text="{Binding DeckB.DisplayName}" FontSize="20" Foreground="White" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBlock Text="DECK B" FontSize="10" Foreground="#666" FontWeight="Bold" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding DeckB.BpmValue, StringFormat='{}{0:F1} BPM'}" FontSize="12" Foreground="#4EC9B0" HorizontalAlignment="Right"/>
                    </StackPanel>
                </StackPanel>
                <Border Background="#FF4081" CornerRadius="4" Padding="10,4" VerticalAlignment="Center">
                    <TextBlock Text="{Binding DeckB.CamelotKey}" FontSize="20" FontWeight="Bold" Foreground="White"/>
                </Border>
            </StackPanel>
        </Grid>
    </Border>

        <!-- 2. Cockpit: Side-by-Side Decks -->
        <Grid Grid.Row="1" ColumnDefinitions="*, 200, *" Margin="15">
            
            <!-- DECK A -->
            <Grid Grid.Column="0" RowDefinitions="Auto, *, Auto">
                <UniformGrid Grid.Row="0" Columns="8" Margin="0,0,0,10">
                    <Button Content="I" Background="#2E7D32" CommandParameter="1" Margin="1" HorizontalAlignment="Stretch" ToolTip.Tip="Intro"/>
                    <Button Content="K" Background="#1565C0" CommandParameter="2" Margin="1" HorizontalAlignment="Stretch" ToolTip.Tip="Kick-In"/>
                    <Button Content="B" Background="#FBC02D" CommandParameter="3" Margin="1" HorizontalAlignment="Stretch" ToolTip.Tip="Build"/>
                    <Button Content="D" Background="#C62828" CommandParameter="4" Margin="1" HorizontalAlignment="Stretch" ToolTip.Tip="Drop"/>
                    <Button Content="B2" Background="#6A1B9A" CommandParameter="5" Margin="1" HorizontalAlignment="Stretch" ToolTip.Tip="Breakdown 2"/>
                    <Button Content="C" Background="#AD1457" CommandParameter="6" Margin="1" HorizontalAlignment="Stretch" ToolTip.Tip="Climax"/>
                    <Button Content="Br" Background="#00838F" CommandParameter="7" Margin="1" HorizontalAlignment="Stretch" ToolTip.Tip="Bridge"/>
                    <Button Content="O" Background="#455A64" CommandParameter="8" Margin="1" HorizontalAlignment="Stretch" ToolTip.Tip="Outro"/>
                </UniformGrid>

                <Border Grid.Row="1" Background="#050505" CornerRadius="8" BorderBrush="#222" BorderThickness="1" ClipToBounds="True">
                    <controls:WaveformControl WaveformData="{Binding DeckA.WaveformData}"
                                              LowBand="{Binding DeckA.LowData}"
                                              MidBand="{Binding DeckA.MidData}"
                                              HighBand="{Binding DeckA.HighData}"
                                              Cues="{Binding DeckA.Cues}"
                                              SegmentedEnergy="{Binding DeckA.SegmentedEnergy}"
                                              Progress="{Binding DeckA.Progress}"/>
                </Border>

                <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="10" Margin="0,15,0,0">
                    <Button Content="PLAY A" Foreground="#4EC9B0" Padding="15,8"/>
                    <Button Content="CUE" Foreground="White" Padding="15,8"/>
                    <Slider Width="200" Minimum="0" Maximum="1" Value="{Binding DeckA.Progress}" VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>

            <!-- CENTER CONSOLE -->
            <StackPanel Grid.Column="1" Spacing="20" Margin="15,0">
                <Border Background="#1A1A1A" Padding="12" CornerRadius="8" BorderBrush="#333" BorderThickness="1">
                    <StackPanel Spacing="8">
                        <TextBlock Text="MASHUP ENGINE" FontSize="10" Foreground="#888" HorizontalAlignment="Center" FontWeight="Bold"/>
                        <TextBlock Text="Inverse Energy" FontSize="12" Foreground="#FFEB3B" HorizontalAlignment="Center"/>
                        <Button Content="AUTO-SYNC" Background="#333" HorizontalAlignment="Stretch" FontSize="10"/>
                    </StackPanel>
                </Border>

                <!-- Piano Root Verifier -->
                <Border Background="#111" Padding="8" CornerRadius="6" BorderBrush="#222" BorderThickness="1">
                    <StackPanel Spacing="5">
                        <TextBlock Text="ROOT VERIFIER" FontSize="9" Foreground="#555" HorizontalAlignment="Center" FontWeight="Bold"/>
                        <UniformGrid Columns="7" Height="45">
                            <Button Content="C" FontSize="9" Command="{Binding PlayToneCommand}" CommandParameter="261.63" Padding="0"/>
                            <Button Content="D" FontSize="9" Command="{Binding PlayToneCommand}" CommandParameter="293.66" Padding="0"/>
                            <Button Content="E" FontSize="9" Command="{Binding PlayToneCommand}" CommandParameter="329.63" Padding="0"/>
                            <Button Content="F" FontSize="9" Command="{Binding PlayToneCommand}" CommandParameter="349.23" Padding="0"/>
                            <Button Content="G" FontSize="9" Command="{Binding PlayToneCommand}" CommandParameter="392.00" Padding="0"/>
                            <Button Content="A" FontSize="9" Command="{Binding PlayToneCommand}" CommandParameter="440.00" Padding="0"/>
                            <Button Content="B" FontSize="9" Command="{Binding PlayToneCommand}" CommandParameter="493.88" Padding="0"/>
                        </UniformGrid>
                    </StackPanel>
                </Border>

                <!-- Mixer Crossfader -->
                <StackPanel VerticalAlignment="Bottom" Margin="0,20,0,0">
                    <TextBlock Text="CROSSFADER" FontSize="10" Foreground="#666" HorizontalAlignment="Center" Margin="0,0,0,8" FontWeight="Bold"/>
                    <Slider Minimum="0" Maximum="1" Value="{Binding CrossfaderPosition}" Height="40" Padding="0"/>
                    <Grid ColumnDefinitions="*, *" Margin="5,0">
                        <TextBlock Grid.Column="0" Text="DECK A" FontSize="9" Foreground="#FF4081" FontWeight="Black"/>
                        <TextBlock Grid.Column="1" Text="DECK B" FontSize="9" Foreground="#4EC9B0" FontWeight="Black" HorizontalAlignment="Right"/>
                    </Grid>
                </StackPanel>
            </StackPanel>

            <!-- DECK B -->
            <Grid Grid.Column="2" RowDefinitions="Auto, *, Auto">
                <UniformGrid Grid.Row="0" Columns="8" Margin="0,0,0,10">
                    <Button Content="I" Background="#2E7D32" Margin="1" HorizontalAlignment="Stretch"/>
                    <Button Content="K" Background="#1565C0" Margin="1" HorizontalAlignment="Stretch"/>
                    <Button Content="B" Background="#FBC02D" Margin="1" HorizontalAlignment="Stretch"/>
                    <Button Content="D" Background="#C62828" Margin="1" HorizontalAlignment="Stretch"/>
                    <Button Content="B2" Background="#6A1B9A" Margin="1" HorizontalAlignment="Stretch"/>
                    <Button Content="C" Background="#AD1457" Margin="1" HorizontalAlignment="Stretch"/>
                    <Button Content="Br" Background="#00838F" Margin="1" HorizontalAlignment="Stretch"/>
                    <Button Content="O" Background="#455A64" Margin="1" HorizontalAlignment="Stretch"/>
                </UniformGrid>

                <Border Grid.Row="1" Background="#050505" CornerRadius="8" BorderBrush="#222" BorderThickness="1" ClipToBounds="True">
                    <controls:WaveformControl WaveformData="{Binding DeckB.WaveformData}"
                                              LowBand="{Binding DeckB.LowData}"
                                              MidBand="{Binding DeckB.MidData}"
                                              HighBand="{Binding DeckB.HighData}"
                                              Cues="{Binding DeckB.Cues}"
                                              SegmentedEnergy="{Binding DeckB.SegmentedEnergy}"
                                              Progress="{Binding DeckB.Progress}"/>
                </Border>

                 <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="10" Margin="0,15,0,0" HorizontalAlignment="Right">
                    <Slider Width="200" Minimum="0" Maximum="1" Value="{Binding DeckB.Progress}" VerticalAlignment="Center"/>
                    <Button Content="PLAY B" Foreground="#4EC9B0" Padding="15,8"/>
                    <Button Content="CUE" Foreground="White" Padding="15,8"/>
                </StackPanel>
            </Grid>
        </Grid>

        <!-- 3. Bottom: Full Library Grid (In-Cockpit Navigation) -->
        <Border Grid.Row="2" Background="#0D0D0D" BorderBrush="#333" BorderThickness="0,1,0,0" Padding="15">
            <Grid RowDefinitions="Auto, *">
                <StackPanel Orientation="Horizontal" Spacing="25" Margin="0,0,0,15">
                    <TextBlock Text="MASHUP RECOMMENDATIONS" FontSize="11" FontWeight="Black" Foreground="#555" LetterSpacing="1.5" VerticalAlignment="Center"/>
                    <Border Background="#151515" CornerRadius="4" Padding="8,2" BorderBrush="#333" BorderThickness="1">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Filter:" FontSize="10" Foreground="#666" VerticalAlignment="Center"/>
                            <TextBlock Text="Â±1 Harmonic Step" FontSize="10" Foreground="#4EC9B0" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
                
                <!-- AI RECOMMENDATIONS (Horizontal List) -->
                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding AiMatches}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="15"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#1A1A1A" CornerRadius="10" Width="280" Padding="15" BorderBrush="#333" BorderThickness="1">
                                    <Grid RowDefinitions="Auto, Auto, *" Margin="5">
                                        <TextBlock Text="{Binding Track.Artist}" FontSize="10" Foreground="#888" TextTrimming="CharacterEllipsis" FontWeight="Bold"/>
                                        <TextBlock Grid.Row="1" Text="{Binding Track.Title}" FontSize="14" Foreground="White" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" Margin="0,2,0,10"/>
                                        
                                        <Grid Grid.Row="2" ColumnDefinitions="Auto, Auto, *, Auto">
                                            <Border Grid.Column="0" Background="#FF4081" CornerRadius="3" Padding="6,2" Margin="0,0,8,0">
                                                <TextBlock Text="{Binding Track.MusicalKey}" FontSize="11" Foreground="White" FontWeight="Black"/>
                                            </Border>
                                            <TextBlock Grid.Column="1" Text="{Binding Track.BPM, StringFormat='{}{0:F0}'}" FontSize="11" Foreground="#4EC9B0" VerticalAlignment="Center" FontWeight="Bold"/>
                                            
                                            <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding Score, StringFormat='{}{0:F0}%'}" FontSize="18" FontWeight="Black" Foreground="#FFD700" VerticalAlignment="Center"/>
                                                <Button Content="LOAD B" FontSize="10" Background="#C62828" Foreground="White" FontWeight="Bold" Padding="12,5"
                                                        Command="{Binding $parent[UserControl].DataContext.LoadToDeckBCommand}" CommandParameter="{Binding}"/>
                                            </StackPanel>
                                        </Grid>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
