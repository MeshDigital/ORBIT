<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:SLSKDONET.ViewModels"
             xmlns:controls="clr-namespace:SLSKDONET.Views.Avalonia.Controls"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="600"
             x:Class="SLSKDONET.Views.Avalonia.TrackInspectorView"
             Background="#1A1A1A">
    
    <Design.DataContext>
        <vm:TrackInspectorViewModel/>
    </Design.DataContext>

    <!-- Main content with progress modal overlay -->
    <Grid RowDefinitions="Auto,*" Margin="20">
        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,20">
            <TextBlock Text="Track Inspector" FontSize="18" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
            <Button Grid.Column="1" 
                    Background="Transparent" 
                    Padding="4"
                    Command="{Binding $parent[UserControl;1].DataContext.CloseInspectorCommand}">
                <TextBlock Text="âœ•" Foreground="#666"/>
            </Button>
        </Grid>

        <!-- Main Content (Tabbed Interface) -->
        <TabControl Grid.Row="1" IsVisible="{Binding HasTrack}" Margin="0,-10,0,0">
            
            <!-- TAB 1: OVERVIEW (Existing Metrics + Forensic Logs) -->
            <TabItem Header="Overview" FontSize="14" FontWeight="SemiBold">
                <ScrollViewer Margin="0,10,0,0">
                    <StackPanel Spacing="24">
                        
                        <!-- HERO SECTION: Album Art + Track Info + Status -->
                        <Border CornerRadius="16" 
                                Padding="24"
                                BoxShadow="0 4 12 0 #33000000">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,0%">
                                    <GradientStop Offset="0" Color="#252526"/>
                                    <GradientStop Offset="1" Color="#1E1E1E"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <Grid ColumnDefinitions="Auto,*">
                                <!-- Album Art -->
                                <Border Width="140" Height="140" 
                                        CornerRadius="12" 
                                        ClipToBounds="True"
                                        BoxShadow="0 8 24 0 #66000000">
                                    <Image Source="{Binding Track.AlbumArtUrl}" 
                                           Stretch="UniformToFill"/>
                                </Border>
                                
                                <!-- Track Metadata + Status -->
                                <StackPanel Grid.Column="1" Margin="24,0,0,0" Spacing="12" VerticalAlignment="Center">
                                    <!-- Title -->
                                    <TextBlock Text="{Binding Track.Title}" 
                                               FontSize="24" 
                                               FontWeight="Bold" 
                                               Foreground="White"
                                               TextWrapping="Wrap"/>
                                    
                                    <!-- Artist -->
                                    <TextBlock Text="{Binding Track.Artist}" 
                                               FontSize="16" 
                                               Foreground="#1DB954"
                                               TextWrapping="Wrap"/>
                                    
                                    <!-- Album -->
                                    <TextBlock Text="{Binding Track.Album}" 
                                               FontSize="13" 
                                               Foreground="#888"
                                               TextWrapping="Wrap"/>
                                    
                                    <!-- Status Badge -->
                                    <Border Background="#1DB95433"
                                            CornerRadius="8" 
                                            Padding="12,6"
                                            HorizontalAlignment="Left"
                                            Margin="0,8,0,0"
                                            IsVisible="{Binding HasAnalysis}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="{Binding StatusBadgeText}" 
                                                       Foreground="#1DB954" 
                                                       FontSize="12"
                                                       FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding AnalysisAge, StringFormat='({0})'}" 
                                                       Foreground="#88BB88" 
                                                       FontSize="11"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Analyzing Badge -->
                                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                        <Border Background="#448AFF33"
                                                CornerRadius="8" 
                                                Padding="12,6"
                                                HorizontalAlignment="Left"
                                               IsVisible="{Binding IsAnalyzing}">
                                            <TextBlock Text="ðŸ”„ Analyzing..." 
                                                       Foreground="#448AFF" 
                                                       FontSize="12"
                                                       FontWeight="SemiBold"/>
                                        </Border>
                                        
                                        <Button Command="{Binding ReFetchUpgradeCommand}"
                                                Classes="accent"
                                                Padding="12,6"
                                                CornerRadius="8"
                                                ToolTip.Tip="Search for better quality or replace missing file">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <TextBlock Text="ðŸš€" FontSize="12"/>
                                                <TextBlock Text="Re-fetch / Upgrade" FontSize="12" FontWeight="SemiBold"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- METRICS GRID: Key Analysis Data -->
                        <UniformGrid Columns="2" Rows="2">
                            <!-- Card 1: Sonic Integrity -->
                            <Border Background="#252526" CornerRadius="12" Padding="20" Margin="0,0,12,12">
                                <StackPanel Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸ›¡ï¸" FontSize="20"/>
                                        <TextBlock Text="Sonic Integrity" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding IntegrityStatusText}" 
                                               FontSize="16" 
                                               FontWeight="Bold"
                                               Foreground="{Binding IntegrityStatusColor}"/>
                                    <TextBlock Text="{Binding SpectralCutoffLabel, StringFormat='Cutoff: {0}'}" 
                                               FontSize="12" 
                                               Foreground="#888"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Card 2: Loudness Analysis -->
                            <Border Background="#252526" CornerRadius="12" Padding="20" Margin="12,0,0,12">
                                <StackPanel Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸ“Š" FontSize="20"/>
                                        <TextBlock Text="Loudness" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding LoudnessLabel}" 
                                               FontSize="16" 
                                               FontWeight="Bold"
                                               Foreground="White"/>
                                    <TextBlock Text="{Binding TruePeakLabel, StringFormat='Peak: {0}'}" 
                                               FontSize="12" 
                                               Foreground="#888"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Card 3: Musical Intelligence -->
                            <Border Background="#252526" CornerRadius="12" Padding="20" Margin="0,12,12,0">
                                <StackPanel Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸŽ¹" FontSize="20"/>
                                        <TextBlock Text="Musical" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding CamelotKey, StringFormat='Key: {0}'}" 
                                               FontSize="16" 
                                               FontWeight="Bold"
                                               Foreground="#00A3FF"/>
                                    <TextBlock Text="{Binding EssentiaBpm, StringFormat='BPM: {0:F1}'}" 
                                               FontSize="12" 
                                               Foreground="#888"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Card 4: Technical Details -->
                            <Border Background="#252526" CornerRadius="12" Padding="20" Margin="12,12,0,0">
                                <StackPanel Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="âš¡" FontSize="20"/>
                                        <TextBlock Text="Technical" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding BitrateLabel}" 
                                               FontSize="16" 
                                               FontWeight="Bold"
                                               Foreground="White"/>
                                    <TextBlock Text="{Binding TechDetailsLabel}" 
                                               FontSize="11" 
                                               Foreground="#888"
                                               TextWrapping="Wrap"/>
                                    <TextBlock Text="{Binding FileSizeLabel}" 
                                               FontSize="11" 
                                               Foreground="#666"
                                               Margin="0,4,0,0"/>
                                </StackPanel>
                            </Border>
                        </UniformGrid>
                        
                        <!-- FORENSIC LOGS: Permanent Section -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="12">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ•µï¸" FontSize="16"/>
                                    <TextBlock Text="Forensic Analysis Logs" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>
                                
                                <ScrollViewer MaxHeight="200">
                                    <ItemsControl ItemsSource="{Binding ForensicLogs}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="#1E1E1E" CornerRadius="4" Margin="0,0,0,8" Padding="12">
                                                    <Grid ColumnDefinitions="Auto,Auto,*">
                                                        <TextBlock Grid.Column="0" 
                                                                   Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}" 
                                                                   Foreground="#666" 
                                                                   Width="65" 
                                                                   FontFamily="Consolas" 
                                                                   FontSize="10"/>
                                                        <Border Grid.Column="1" 
                                                                Background="#333" 
                                                                CornerRadius="4" 
                                                                Padding="6,2" 
                                                                Margin="12,0" 
                                                                VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding Stage}" 
                                                                       Foreground="#AAA" 
                                                                       FontSize="9" 
                                                                       FontWeight="SemiBold"/>
                                                        </Border>
                                                        <TextBlock Grid.Column="2" 
                                                                   Text="{Binding Message}" 
                                                                   Foreground="White" 
                                                                   TextWrapping="Wrap" 
                                                                   FontSize="11"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            
            <!-- TAB 2: SPECTRAL ANALYSIS (Spectrogram) -->
            <TabItem Header="Spectral Analysis" FontSize="14" FontWeight="SemiBold">
                <Grid>
                    <!-- Generation State -->
                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16" IsVisible="{Binding SpectrogramBitmap, Converter={x:Static ObjectConverters.IsNull}}">
                        <TextBlock Text="ðŸ“‰" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="Visualize the full frequency spectrum to detect upscaling." 
                                   Foreground="#AAA" HorizontalAlignment="Center"/>
                        
                        <Button Classes="accent" 
                                Command="{Binding GenerateSpectrogramCommand}" 
                                IsEnabled="{Binding !IsGeneratingSpectrogram}"
                                HorizontalAlignment="Center"
                                Padding="20,10"
                                CornerRadius="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="âš¡" IsVisible="{Binding !IsGeneratingSpectrogram}"/>
                                <TextBlock Text="Generate Spectrogram" FontWeight="Bold"/>
                            </StackPanel>
                        </Button>
                        
                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center" IsVisible="{Binding IsGeneratingSpectrogram}">
                            <TextBlock Text="â³"/>
                            <TextBlock Text="Generating high-res spectrogram..." Foreground="#448AFF"/>
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- The Image -->
                    <Grid IsVisible="{Binding SpectrogramBitmap, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <Border CornerRadius="8" ClipToBounds="True" Background="#000">
                             <Image Source="{Binding SpectrogramBitmap}" Stretch="Uniform" RenderOptions.BitmapInterpolationMode="HighQuality"/>
                        </Border>
                        
                        <!-- Overlay Header -->
                        <Border VerticalAlignment="Top" HorizontalAlignment="Left" 
                                Background="#99000000" CornerRadius="0,0,8,0" Padding="12,6">
                             <TextBlock Text="Frequency Spectrum (Log Scale)" Foreground="#AAA" FontSize="11"/>
                        </Border>
                    </Grid>
                    
                    <!-- Refresh Button -->
                    <Button VerticalAlignment="Top" HorizontalAlignment="Right"
                            Margin="10"
                            Background="#33000000"
                            BorderBrush="#44FFFFFF"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="8,4"
                            Command="{Binding GenerateSpectrogramCommand}"
                            IsVisible="{Binding SpectrogramBitmap, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <TextBlock Text="ðŸ”„ Refresh" FontSize="11"/>
                    </Button>
                </Grid>
            </TabItem>

            <!-- TAB 3: PRO DJ (Mixes Well With + Radar) -->
            <TabItem Header="Pro DJ" FontSize="14" FontWeight="SemiBold">
                <ScrollViewer Margin="0,10,0,0">
                    <StackPanel Spacing="24">
                        <!-- Mixes Well With -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="12">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸŽ§" FontSize="16"/>
                                    <TextBlock Text="Mixes Well With" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>
                                <ItemsControl ItemsSource="{Binding MixesWellMatches}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#1E1E1E" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Track.Title}" Foreground="White" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Text="{Binding Track.Artist}" Foreground="#888" FontSize="12"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                         <Border Background="#333" CornerRadius="4" Padding="6,2">
                                                             <TextBlock Text="{Binding Track.Key}" Foreground="#00A3FF" FontSize="11" FontWeight="Bold"/>
                                                         </Border>
                                                         <Border Background="#333" CornerRadius="4" Padding="6,2">
                                                             <TextBlock Text="{Binding Track.Bpm, StringFormat='{}{0:F0}'}" Foreground="#AAA" FontSize="11"/>
                                                         </Border>
                                                         <TextBlock Text="{Binding CompatibilityScore, StringFormat='{}{0}%'}" Foreground="#1DB954" FontSize="11" VerticalAlignment="Center" FontWeight="Bold"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <TextBlock Text="No harmonic matches found in library" Foreground="#666" FontStyle="Italic" 
                                           HorizontalAlignment="Center" Margin="0,8"
                                           IsVisible="{Binding !MixesWellMatches.Count}"/>
                            </StackPanel>
                        </Border>

                        <!-- Vibe Radar (Simple Bars) -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="16">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ“¡" FontSize="16"/>
                                    <TextBlock Text="Vibe Radar" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>
                                
                                <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="60,*,40">
                                    <!-- Energy -->
                                    <TextBlock Text="Energy" Foreground="#AAA" VerticalAlignment="Center" FontSize="12" Margin="0,0,0,12"/>
                                    <ProgressBar Grid.Column="1" Value="{Binding VibeEnergy}" Maximum="100" Height="8" Margin="12,0,0,12" Foreground="#FF5252" Background="#111" CornerRadius="4"/>
                                    <TextBlock Grid.Column="2" Text="{Binding VibeEnergy, StringFormat='{}{0:F0}'}" Foreground="White" FontSize="12" FontWeight="SemiBold" TextAlignment="Right" Margin="0,0,0,12"/>

                                    <!-- Dance -->
                                    <TextBlock Grid.Row="1" Text="Dance" Foreground="#AAA" VerticalAlignment="Center" FontSize="12" Margin="0,0,0,12"/>
                                    <ProgressBar Grid.Row="1" Grid.Column="1" Value="{Binding VibeDance}" Maximum="100" Height="8" Margin="12,0,0,12" Foreground="#448AFF" Background="#111" CornerRadius="4"/>
                                    <TextBlock Grid.Row="1" Grid.Column="2" Text="{Binding VibeDance, StringFormat='{}{0:F0}'}" Foreground="White" FontSize="12" FontWeight="SemiBold" TextAlignment="Right" Margin="0,0,0,12"/>

                                    <!-- Mood -->
                                    <TextBlock Grid.Row="2" Text="Mood" Foreground="#AAA" VerticalAlignment="Center" FontSize="12"/>
                                    <ProgressBar Grid.Row="2" Grid.Column="1" Value="{Binding VibeMood}" Maximum="100" Height="8" Margin="12,0" Foreground="#69F0AE" Background="#111" CornerRadius="4"/>
                                    <TextBlock Grid.Row="2" Grid.Column="2" Text="{Binding VibeMood, StringFormat='{}{0:F0}'}" Foreground="White" FontSize="12" FontWeight="SemiBold" TextAlignment="Right"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Other Versions -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="12">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ‘¯" FontSize="16"/>
                                    <TextBlock Text="Other Versions" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>
                                <ItemsControl ItemsSource="{Binding OtherVersions}">
                                     <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#1E1E1E" CornerRadius="6" Padding="8" Margin="0,0,0,4">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding ResolvedFilePath}" Foreground="#AAA" TextTrimming="CharacterEllipsis" FontSize="11" ToolTip.Tip="{Binding ResolvedFilePath}"/>
                                                        <TextBlock Text="{Binding Status}" Foreground="#666" FontSize="10"/>
                                                    </StackPanel>
                                                    <Border Grid.Column="1" Background="#333" CornerRadius="4" Padding="6,2" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Bitrate, StringFormat='{}{0}k'}" Foreground="#FFF" FontSize="10" FontWeight="Bold"/>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                     </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <TextBlock Text="No other versions found" Foreground="#666" FontStyle="Italic" 
                                           HorizontalAlignment="Center" Margin="0,8"
                                           IsVisible="{Binding !OtherVersions.Count}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Empty State -->
        <StackPanel Grid.Row="1" VerticalAlignment="Center" IsVisible="{Binding HasTrack, Converter={StaticResource BoolInverseConverter}}">
            <TextBlock Text="ðŸ”" FontSize="48" HorizontalAlignment="Center"/>
            <TextBlock Text="Select a track to inspect" FontSize="16" Foreground="#666" HorizontalAlignment="Center" Margin="0,16,0,0"/>
        </StackPanel>
        
        <!-- Progress Modal Overlay -->
        <ContentControl Grid.Row="0" Grid.RowSpan="2"
                        Content="{Binding ProgressModal}"
                        IsVisible="{Binding IsProgressModalVisible}">
            <ContentControl.ContentTemplate>
                <DataTemplate>
                    <controls:AnalysisProgressModal/>
                </DataTemplate>
            </ContentControl.ContentTemplate>
        </ContentControl>
    </Grid>
</UserControl>
