<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:SLSKDONET.ViewModels"
             xmlns:models="clr-namespace:SLSKDONET.Models"
             xmlns:essentia="clr-namespace:SLSKDONET.Data.Essentia"
             xmlns:controls="clr-namespace:SLSKDONET.Views.Avalonia.Controls"
             xmlns:conv="clr-namespace:SLSKDONET.Views.Avalonia.Converters"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="600"
             x:Class="SLSKDONET.Views.Avalonia.TrackInspectorView"
             Background="#1A1A1A">
    
    <Design.DataContext>
        <vm:TrackInspectorViewModel/>
    </Design.DataContext>

    <!-- Main content with progress modal overlay -->
    <Grid RowDefinitions="Auto,*" Margin="20">
        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,20">
            <TextBlock Text="Track Inspector" FontSize="18" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
            <Button Grid.Column="1" 
                    Background="Transparent" 
                    Padding="4"
                    Command="{Binding $parent[UserControl;1].DataContext.CloseInspectorCommand}">
                <TextBlock Text="âœ•" Foreground="#666"/>
            </Button>
        </Grid>

        <!-- Main Content (Tabbed Interface) -->
        <TabControl Grid.Row="1" IsVisible="{Binding HasTrack}" Margin="0,-10,0,0">
            
            <!-- TAB 1: OVERVIEW (Existing Metrics + Forensic Logs) -->
            <TabItem Header="Overview" FontSize="14" FontWeight="SemiBold">
                <ScrollViewer Margin="0,10,0,0">
                    <StackPanel Spacing="24">
                        
                        <!-- HERO SECTION: Album Art + Track Info + Status -->
                        <Border CornerRadius="16" 
                                Padding="24"
                                BoxShadow="0 4 12 0 #33000000">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,0%">
                                    <GradientStop Offset="0" Color="#252526"/>
                                    <GradientStop Offset="1" Color="#1E1E1E"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <Grid ColumnDefinitions="Auto,*">
                                <!-- Album Art -->
                                <Border Width="140" Height="140" 
                                        CornerRadius="12" 
                                        ClipToBounds="True"
                                        BoxShadow="0 8 24 0 #66000000">
                                    <Image Source="{Binding Track.AlbumArtUrl}" 
                                           Stretch="UniformToFill"/>
                                </Border>
                                
                                <!-- Track Metadata + Status -->
                                <StackPanel Grid.Column="1" Margin="24,0,0,0" Spacing="12" VerticalAlignment="Center">
                                    <!-- Title -->
                                    <TextBlock Text="{Binding Track.Title}" 
                                               FontSize="24" 
                                               FontWeight="Bold" 
                                               Foreground="White"
                                               TextWrapping="Wrap"/>
                                    
                                    <!-- Artist -->
                                    <TextBlock Text="{Binding Track.Artist}" 
                                               FontSize="16" 
                                               Foreground="#1DB954"
                                               TextWrapping="Wrap"/>
                                    
                                    <!-- Album -->
                                    <TextBlock Text="{Binding Track.Album}" 
                                               FontSize="13" 
                                               Foreground="#888"
                                               TextWrapping="Wrap"/>
                                    
                                    <!-- Status Badge -->
                                    <Border Background="#1DB95433"
                                            CornerRadius="8" 
                                            Padding="12,6"
                                            HorizontalAlignment="Left"
                                            Margin="0,8,0,0"
                                            IsVisible="{Binding HasAnalysis}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="{Binding StatusBadgeText}" 
                                                       Foreground="#1DB954" 
                                                       FontSize="12"
                                                       FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding AnalysisAge, StringFormat='({0})'}" 
                                                       Foreground="#88BB88" 
                                                       FontSize="11"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Analyzing Badge -->
                                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                        <Border Background="#448AFF33"
                                                CornerRadius="8" 
                                                Padding="12,6"
                                                HorizontalAlignment="Left"
                                               IsVisible="{Binding IsAnalyzing}">
                                            <TextBlock Text="ðŸ”„ Analyzing..." 
                                                       Foreground="#448AFF" 
                                                       FontSize="12"
                                                       FontWeight="SemiBold"/>
                                        </Border>
                                        
                                        <Button Command="{Binding ReFetchUpgradeCommand}"
                                                Classes="accent"
                                                Padding="12,6"
                                                CornerRadius="8"
                                                ToolTip.Tip="Search for better quality or replace missing file">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <TextBlock Text="ðŸš€" FontSize="12"/>
                                                <TextBlock Text="Re-fetch / Upgrade" FontSize="12" FontWeight="SemiBold"/>
                                            </StackPanel>
                                        </Button>

                                        <Button Command="{Binding CloneCommand}"
                                                Background="#333"
                                                Padding="12,6"
                                                CornerRadius="8"
                                                ToolTip.Tip="Create an independent physical copy of this file">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <TextBlock Text="ðŸ‘¯" FontSize="12"/>
                                                <TextBlock Text="Clone" FontSize="12" FontWeight="SemiBold"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- NEW: Interactive Waveform (Core of Phase 10) -->
                        <Border Background="#111" CornerRadius="8" Height="100" Padding="1" ClipToBounds="True">
                            <controls:WaveformControl Name="InspectorWaveform"
                                                    WaveformData="{Binding Track.WaveformDataObj}"
                                                    LowBand="{Binding Track.LowData}"
                                                    MidBand="{Binding Track.MidData}"
                                                    HighBand="{Binding Track.HighData}"
                                                    Cues="{Binding Cues}"
                                                    Height="100"/>
                        </Border>
                        
                        <!-- METRICS GRID: Key Analysis Data -->
                        <UniformGrid Columns="2" Rows="2">
                            <!-- Card 1: Sonic Integrity -->
                            <Border Background="#252526" CornerRadius="12" Padding="20" Margin="0,0,12,12">
                                <StackPanel Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸ›¡ï¸" FontSize="20"/>
                                        <TextBlock Text="Sonic Integrity" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding IntegrityStatusText}" 
                                               FontSize="16" 
                                               FontWeight="Bold"
                                               Foreground="{Binding IntegrityStatusColor}"/>
                                    <TextBlock Text="{Binding SpectralCutoffLabel, StringFormat='Cutoff: {0}'}" 
                                               FontSize="12" 
                                               Foreground="#888"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Card 2: Loudness Analysis -->
                            <Border Background="#252526" CornerRadius="12" Padding="20" Margin="12,0,0,12">
                                <StackPanel Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸ“Š" FontSize="20"/>
                                        <TextBlock Text="Loudness" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding LoudnessLabel}" 
                                               FontSize="16" 
                                               FontWeight="Bold"
                                               Foreground="White"/>
                                    <StackPanel Orientation="Horizontal" Spacing="12">
                                        <TextBlock Text="{Binding TruePeakLabel, StringFormat='Peak: {0}'}" 
                                                   FontSize="12" 
                                                   Foreground="#888"/>
                                        <TextBlock Text="{Binding DynamicRangeLabel, StringFormat='Dyn: {0}'}" 
                                                   FontSize="12" 
                                                   FontWeight="SemiBold"
                                                   Foreground="#00BFFF"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                            
                            <!-- Card 3: Musical Intelligence (Diff View) -->
                            <Border Background="#252526" CornerRadius="12" Padding="20" Margin="0,12,12,0">
                                <StackPanel Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸŽ¹" FontSize="20"/>
                                        <TextBlock Text="Musical" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>

                                    <!-- Key Section -->
                                    <StackPanel IsVisible="{Binding HasKeyMismatch}">
                                         <TextBlock Text="Key Mismatch" FontSize="10" Foreground="#FF5252" FontWeight="Bold"/>
                                         <StackPanel Orientation="Horizontal" Spacing="8">
                                             <TextBlock Text="{Binding Track.Key}" TextDecorations="Strikethrough" Foreground="#666"/>
                                             <TextBlock Text="âž¡" Foreground="#888"/>
                                             <TextBlock Text="{Binding DiffKeyLabel}" Foreground="#00A3FF" FontWeight="Bold"/>
                                         </StackPanel>
                                    </StackPanel>
                                    <TextBlock Text="{Binding CamelotKey, StringFormat='Key: {0}'}" 
                                               IsVisible="{Binding !HasKeyMismatch}"
                                               FontSize="16" FontWeight="Bold" Foreground="#00A3FF"/>

                                    <!-- BPM Section -->
                                    <StackPanel IsVisible="{Binding HasBpmMismatch}">
                                         <TextBlock Text="BPM Drift" FontSize="10" Foreground="#FF5252" FontWeight="Bold" Margin="0,4,0,0"/>
                                         <StackPanel Orientation="Horizontal" Spacing="8">
                                             <TextBlock Text="{Binding Track.BPM, StringFormat='{}{0:F0}'}" TextDecorations="Strikethrough" Foreground="#666"/>
                                             <TextBlock Text="âž¡" Foreground="#888"/>
                                             <TextBlock Text="{Binding DiffBpmLabel}" Foreground="#00A3FF" FontWeight="Bold"/>
                                         </StackPanel>
                                    </StackPanel>
                                    <TextBlock Text="{Binding BpmLabel}" 
                                               IsVisible="{Binding !HasBpmMismatch}"
                                               FontSize="12" Foreground="#888"/>

                                     <!-- Confidence & Source -->
                                     <Border Background="#333" CornerRadius="4" Padding="6,2" HorizontalAlignment="Left" Margin="0,4,0,0"
                                             ToolTip.Tip="Curation Confidence &amp; Source">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="{Binding CurationConfidence}" FontSize="10" Foreground="#CCC" FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding AnalysisSource, StringFormat='({0})'}" FontSize="10" Foreground="#888"/>
                                        </StackPanel>
                                     </Border>
                                </StackPanel>
                            </Border>
                            
                            <!-- Card 4: Technical Details -->
                            <Border Background="#252526" CornerRadius="12" Padding="20" Margin="12,12,0,0">
                                <StackPanel Spacing="10">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="âš¡" FontSize="20"/>
                                        <TextBlock Text="Technical" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>
                                    
                                    <!-- Primary: Bitrate -->
                                    <TextBlock Text="{Binding BitrateLabel}" 
                                               FontSize="16" 
                                               FontWeight="Bold"
                                               Foreground="White"/>
                                    
                                    <!-- Secondary: Freq Cutoff (Phase 14C) -->
                                    <StackPanel Spacing="2">
                                        <TextBlock Text="OFFICIAL CUTOFF" FontSize="9" Foreground="#666" FontWeight="Bold"/>
                                        <TextBlock Text="{Binding FrequencyCutoffLabel}" FontSize="12" Foreground="#CCC"/>
                                    </StackPanel>

                                    <!-- Tertiary: Codec & Size -->
                                    <TextBlock Text="{Binding TechDetailsLabel}" 
                                               FontSize="11" 
                                               Foreground="#888"
                                               TextWrapping="Wrap"/>
                                    <TextBlock Text="{Binding FileSizeLabel}" 
                                               FontSize="11" 
                                               Foreground="#666"/>
                                </StackPanel>
                            </Border>

                        </UniformGrid>
                        
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            
            <!-- TAB 2: SEARCH AUDIT (Forensic Logs & Rejections) -->
            <TabItem Header="Search Audit" FontSize="14" FontWeight="SemiBold">
                <Grid Margin="0,10,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Audit Summary Header -->
                    <Border Grid.Row="0" Background="#252526" CornerRadius="8" Padding="16" Margin="0,0,0,12">
                        <StackPanel Orientation="Horizontal" Spacing="16">
                            <StackPanel>
                                <TextBlock Text="REJECTION RATE" FontSize="10" Foreground="#AAA" FontWeight="Bold"/>
                                <TextBlock Text="--%" FontSize="20" Foreground="White" FontWeight="SemiBold"/>
                            </StackPanel>
                            <Rectangle Width="1" Fill="#333" Margin="0,4"/>
                            <StackPanel>
                                <TextBlock Text="TOTAL ATTEMPTS" FontSize="10" Foreground="#AAA" FontWeight="Bold"/>
                                <TextBlock Text="{Binding ForensicLogs.Count}" FontSize="20" Foreground="White" FontWeight="SemiBold"/>
                            </StackPanel>
                            <Rectangle Width="1" Fill="#333" Margin="0,4"/>
                             <Button Command="{Binding ExportLogsCommand}" 
                                     Classes="outline"
                                     Padding="12,6"
                                     CornerRadius="4"
                                     VerticalAlignment="Center">
                                 <StackPanel Orientation="Horizontal" Spacing="8">
                                     <TextBlock Text="ðŸ“„" FontSize="12"/>
                                     <TextBlock Text="Export Log" FontSize="12"/>
                                 </StackPanel>
                             </Button>
                        </StackPanel>
                    </Border>
                    
                    <!-- Logs DataGrid -->
                    <DataGrid Grid.Row="1" ItemsSource="{Binding ForensicLogs}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              GridLinesVisibility="Horizontal"
                              Background="#1E1E1E"
                              RowBackground="#1E1E1E"
                              HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Time" Binding="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}" Width="80" Foreground="#888"/>
                            <DataGridTemplateColumn Header="Stage" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Background="#333" CornerRadius="4" Padding="6,2" HorizontalAlignment="Left" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Stage}" Foreground="#AAA" FontSize="11"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Level" Width="80">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Level}" 
                                                   VerticalAlignment="Center"
                                                   FontWeight="Bold"
                                                   FontSize="11">
                                            <TextBlock.Foreground>
                                                <Binding Path="Level" Converter="{x:Static conv:LogLevelColorConverter.Instance}"/>
                                            </TextBlock.Foreground>
                                        </TextBlock>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Message" Binding="{Binding Message}" Width="*" Foreground="White"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
            
            <!-- TAB 2: SPECTRAL ANALYSIS (Spectrogram) -->
            <TabItem Header="Spectral Analysis" FontSize="14" FontWeight="SemiBold">
                <Grid Margin="0,10,0,0">
                    <controls:SpectrogramControl SpectrogramBitmap="{Binding SpectrogramBitmap}" Height="300" />
                </Grid>
            </TabItem>
            <!-- TAB 3: PRO DJ (Mixes Well With + Radar) -->
            <TabItem Header="Pro DJ" FontSize="14" FontWeight="SemiBold">
                <ScrollViewer Margin="0,10,0,0">
                    <StackPanel Spacing="24">
                        <!-- Mixes Well With -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="12">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸŽ§" FontSize="16"/>
                                    <TextBlock Text="Mixes Well With" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>
                                <ItemsControl ItemsSource="{Binding MixesWellMatches}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#1E1E1E" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Track.Title}" Foreground="White" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Text="{Binding Track.Artist}" Foreground="#888" FontSize="12"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                         <Border Background="#333" CornerRadius="4" Padding="6,2">
                                                             <TextBlock Text="{Binding Track.Key}" Foreground="#00A3FF" FontSize="11" FontWeight="Bold"/>
                                                         </Border>
                                                         <Border Background="#333" CornerRadius="4" Padding="6,2">
                                                             <TextBlock Text="{Binding Track.Bpm, StringFormat='{}{0:F0}'}" Foreground="#AAA" FontSize="11"/>
                                                         </Border>
                                                         <TextBlock Text="{Binding CompatibilityScore, StringFormat='{}{0}%'}" Foreground="#1DB954" FontSize="11" VerticalAlignment="Center" FontWeight="Bold"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <TextBlock Text="No harmonic matches found in library" Foreground="#666" FontStyle="Italic" 
                                           HorizontalAlignment="Center" Margin="0,8"
                                           IsVisible="{Binding !MixesWellMatches.Count}"/>
                            </StackPanel>
                        </Border>

                        <!-- Vibe Radar (Sonic Profile) -->
                        <Border Background="#252526" CornerRadius="12" Padding="16" IsVisible="{Binding Track.HasAnalysis}">
                            <StackPanel Spacing="16">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="{StaticResource radar_regular}" Foreground="{DynamicResource SystemAccentColor}" Width="16" Height="16"/>
                                    <TextBlock Text="SONIC PROFILE" FontSize="14" FontWeight="SemiBold" Foreground="#AAA" VerticalAlignment="Center"/>
                                </StackPanel>

                                <!-- Reusable Sonic Profile Control (Energy, Mood, Vocals) -->
                                <controls:SonicProfileControl Profile="{Binding Track.SonicProfile}" />

                                <!-- Danceability & Genre (Keep separate for now) -->
                                <Grid ColumnDefinitions="*,*">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <PathIcon Data="{StaticResource people_checkmark_regular}" 
                                                  Width="14" Height="14"
                                                  Foreground="{DynamicResource SystemAccentColor}"
                                                  Opacity="{Binding Track.Danceability, Converter={x:Static conv:OpacityMultiplierConverter.Instance}}"/>
                                        
                                        <TextBlock Text="Danceable" FontSize="12" VerticalAlignment="Center"
                                                   Opacity="{Binding Track.Danceability, Converter={x:Static conv:OpacityMultiplierConverter.Instance}}"/>
                                    </StackPanel>
                                </Grid>
                                
                                <!-- Sonic Badges (Subgenre, Mood, Type) -->
                                <WrapPanel Orientation="Horizontal">
                                    <!-- Subgenre -->
                                    <Border Background="{DynamicResource SurfaceRegionBrush}" 
                                            CornerRadius="4" Padding="8,4" Margin="0,0,8,4"
                                            IsVisible="{Binding HasSubgenre}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <PathIcon Data="{StaticResource tag_regular}" Width="10" Height="10" Opacity="0.5"/>
                                            <TextBlock Text="{Binding ElectronicSubgenre}" 
                                                       FontSize="11" FontStyle="Italic" Foreground="#CCC"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Mood -->
                                    <Border Background="#1B5E20" 
                                            CornerRadius="4" Padding="8,4" Margin="0,0,8,4"
                                            IsVisible="{Binding HasMood}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="âœ¨" FontSize="10"/>
                                            <TextBlock Text="{Binding MoodTag}" 
                                                       FontSize="11" FontWeight="SemiBold" Foreground="#A5D6A7"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Voice / Instrumental -->
                                    <Border Background="#311B92" 
                                            CornerRadius="4" Padding="8,4" Margin="0,0,8,4"
                                            IsVisible="{Binding HasVoiceInstrumental}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="ðŸŽ¤" FontSize="10"/>
                                            <TextBlock Text="{Binding VoiceInstrumentalLabel}" 
                                                       FontSize="11" FontWeight="SemiBold" Foreground="#D1C4E9"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- DJ Tool Warning -->
                                    <Border Background="#B71C1C" 
                                            CornerRadius="4" Padding="8,4" Margin="0,0,8,4"
                                            IsVisible="{Binding IsDjTool}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="ðŸ› " FontSize="10"/>
                                            <TextBlock Text="DJ TOOL" 
                                                       FontSize="11" FontWeight="Bold" Foreground="#FFCDD2"/>
                                        </StackPanel>
                                    </Border>
                                </WrapPanel>
                            </StackPanel>
                        </Border>

                        <!-- Other Versions -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="12">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ‘¯" FontSize="16"/>
                                    <TextBlock Text="Other Versions" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>
                                <ItemsControl ItemsSource="{Binding OtherVersions}">
                                     <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#1E1E1E" CornerRadius="6" Padding="8" Margin="0,0,0,4">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding ResolvedFilePath}" Foreground="#AAA" TextTrimming="CharacterEllipsis" FontSize="11" ToolTip.Tip="{Binding ResolvedFilePath}"/>
                                                        <TextBlock Text="{Binding Status}" Foreground="#666" FontSize="10"/>
                                                    </StackPanel>
                                                    <Border Grid.Column="1" Background="#333" CornerRadius="4" Padding="6,2" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Bitrate, StringFormat='{}{0}k'}" Foreground="#FFF" FontSize="10" FontWeight="Bold"/>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                     </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <TextBlock Text="No other versions found" Foreground="#666" FontStyle="Italic" 
                                           HorizontalAlignment="Center" Margin="0,8"
                                           IsVisible="{Binding !OtherVersions.Count}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- TAB 4: PREPARATION (Cues & Metadata Management) -->
            <TabItem Header="Preparation" FontSize="14" FontWeight="SemiBold">
                <ScrollViewer Margin="0,10,0,0">
                    <StackPanel Spacing="24">
                        <!-- Cue List -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="16">
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸ“" FontSize="16"/>
                                        <TextBlock Text="Cue Points" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                        <Button Command="{Binding AddCueCommand}" Classes="accent" Padding="8,4" CornerRadius="4">
                                            <TextBlock Text="+ Add Reference" FontSize="11" FontWeight="Bold"/>
                                        </Button>
                                        <Button Command="{Binding SaveCuesCommand}" Classes="success" Padding="8,4" CornerRadius="4">
                                            <TextBlock Text="ðŸ’¾ Save" FontSize="11" FontWeight="Bold"/>
                                        </Button>
                                        <Button Command="{Binding SyncTagsCommand}" Background="#333" Padding="8,4" CornerRadius="4" ToolTip.Tip="Inject cues into file tags (Serato/Traktor)">
                                            <TextBlock Text="ðŸ·ï¸ Sync Tags" FontSize="11" FontWeight="Bold"/>
                                        </Button>
                                    </StackPanel>
                                </Grid>

                                <ItemsControl ItemsSource="{Binding Cues}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#1E1E1E" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                                                    <!-- Color Indicator -->
                                                    <Border Width="4" Height="24" CornerRadius="2" Background="{Binding Color}" Margin="0,0,12,0"/>
                                                    
                                                    <!-- Name & Role -->
                                                    <StackPanel VerticalAlignment="Center">
                                                        <TextBox Text="{Binding Name}" FontWeight="SemiBold" Background="Transparent" BorderThickness="0" Padding="0" VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding Role}" FontSize="10" Foreground="#666"/>
                                                    </StackPanel>
                                                    
                                                    <!-- Timestamp -->
                                                    <StackPanel Grid.Column="2" VerticalAlignment="Center" Margin="20,0">
                                                        <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:F2}s'}" Foreground="#00BFFF" FontFamily="Consolas" FontSize="12" FontWeight="Bold"/>
                                                    </StackPanel>
                                                    
                                                    <!-- Delete -->
                                                    <Button Grid.Column="3" 
                                                            Command="{Binding $parent[UserControl].DataContext.DeleteCueCommand}" 
                                                            CommandParameter="{Binding}"
                                                            Background="Transparent" BorderThickness="0">
                                                        <PathIcon Data="{StaticResource delete_regular}" Width="16" Height="16" Foreground="#FF4444"/>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <TextBlock Text="No cues generated or added yet." Foreground="#666" FontStyle="Italic" 
                                           HorizontalAlignment="Center" Margin="0,8"
                                           IsVisible="{Binding !HasCues}"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- Metadata Actions -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="12">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ“" FontSize="16"/>
                                    <TextBlock Text="Preparation Actions" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>
                                
                                <WrapPanel ItemWidth="180">
                                    <SplitButton Command="{Binding ForceReAnalyzeCommand}" Margin="4" CornerRadius="6" HorizontalAlignment="Stretch">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="ðŸ”„" FontSize="12"/>
                                            <TextBlock Text="Force Re-Analysis" FontSize="12"/>
                                        </StackPanel>
                                        <SplitButton.Flyout>
                                            <MenuFlyout>
                                                <MenuItem Header="Tier 1: Basic (Fast)" Command="{Binding ForceReAnalyzeTieredCommand}" CommandParameter="{x:Static essentia:AnalysisTier.Tier1}" />
                                                <MenuItem Header="Tier 2: Detailed" Command="{Binding ForceReAnalyzeTieredCommand}" CommandParameter="{x:Static essentia:AnalysisTier.Tier2}" />
                                                <MenuItem Header="Tier 3: Specialized (Deep)" Command="{Binding ForceReAnalyzeTieredCommand}" CommandParameter="{x:Static essentia:AnalysisTier.Tier3}" />
                                            </MenuFlyout>
                                        </SplitButton.Flyout>
                                    </SplitButton>
                                    <Button Command="{Binding MarkAsVerifiedCommand}" 
                                            IsEnabled="{Binding HasAnalysis}"
                                            Margin="4" CornerRadius="6" HorizontalAlignment="Stretch" Classes="success">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="âœ…" FontSize="12"/>
                                            <TextBlock Text="Approve &amp; Verify" FontSize="12" FontWeight="Bold"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Command="{Binding GenerateSpectrogramCommand}" Margin="4" CornerRadius="6" HorizontalAlignment="Stretch">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <PathIcon Data="{StaticResource radar_regular}" Width="14" Height="14"/>
                                            <TextBlock Text="View Spectrum" FontSize="12"/>
                                        </StackPanel>
                                    </Button>
                                </WrapPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            
            <!-- TAB 5: UNIVERSAL DISCOVERY (AI Similarity + Credits) -->
            <TabItem Header="Discovery" FontSize="14" FontWeight="SemiBold">
                <ScrollViewer Margin="0,10,0,0">
                    <StackPanel Spacing="24">
                        <!-- AI Sonic Similarity -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="16">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ”®" FontSize="16"/>
                                    <TextBlock Text="Sonic Similarity (AI)" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>
                                <TextBlock Text="Tracks with the most similar acoustic texture and vibe, calculated using 128D AI embeddings." 
                                           FontSize="11" Foreground="#666" TextWrapping="Wrap"/>

                                <ItemsControl ItemsSource="{Binding SonicMatches}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#1E1E1E" CornerRadius="8" Padding="12" Margin="0,0,0,8">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="{Binding Title}" Foreground="White" FontWeight="Bold" TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Text="{Binding Artist}" Foreground="#1DB954" FontSize="12"/>
                                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                                            <Border Background="#333" CornerRadius="4" Padding="6,2">
                                                                <TextBlock Text="{Binding MatchReason}" Foreground="#FFF" FontSize="10" FontWeight="Bold"/>
                                                            </Border>
                                                            <!-- Match Source Badge -->
                                                            <Border Background="#22448AFF" BorderBrush="#448AFF" BorderThickness="1" CornerRadius="4" Padding="6,2" 
                                                                    IsVisible="{Binding MatchSource, Converter={x:Static conv:StringConverters.IsNotNullOrEmpty}}">
                                                                <TextBlock Text="{Binding MatchSource}" Foreground="#448AFF" FontSize="9" FontWeight="SemiBold"/>
                                                            </Border>
                                                            <TextBlock Text="{Binding SimilarityPercent, StringFormat='{}{0:F1}% Match'}" 
                                                                       Foreground="#888" FontSize="11" VerticalAlignment="Center"/>
                                                        </StackPanel>
                                                        
                                                        <!-- Visual Similarity Bar -->
                                                        <ProgressBar Value="{Binding SimilarityPercent}" Maximum="100" Height="4" Margin="0,4,0,0" 
                                                                     Background="#111" Foreground="#1DB954" CornerRadius="2"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Right">
                                                        <TextBlock Text="{Binding Bpm, StringFormat='{}{0:F0} BPM'}" Foreground="#666" FontSize="11" HorizontalAlignment="Right"/>
                                                        <TextBlock Text="{Binding MoodTag}" Foreground="#88BB88" FontSize="11" HorizontalAlignment="Right"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <TextBlock Text="No sonic matches found. Try analyzing more tracks." Foreground="#666" FontStyle="Italic" 
                                           HorizontalAlignment="Center" Margin="0,8"
                                           IsVisible="{Binding !SonicMatches.Count}"/>
                            </StackPanel>
                        </Border>

                        <!-- MusicBrainz Credits -->
                        <Border Background="#252526" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="16">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ“œ" FontSize="16"/>
                                    <TextBlock Text="Deep Credits (MusicBrainz)" FontSize="14" FontWeight="SemiBold" Foreground="#AAA"/>
                                </StackPanel>

                                <StackPanel IsVisible="{Binding MbCredits, Converter={x:Static ObjectConverters.IsNotNull}}" Spacing="12">
                                    <!-- Release Info -->
                                    <Border Background="#1A1A1A" BorderBrush="#333" BorderThickness="1" CornerRadius="8" Padding="14">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackPanel Spacing="4">
                                                <TextBlock Text="RELEASE" FontSize="9" Foreground="#666" FontWeight="Black" LetterSpacing="1"/>
                                                <TextBlock Text="{Binding MbCredits.ReleaseTitle}" Foreground="White" FontSize="14" FontWeight="Bold" TextWrapping="Wrap"/>
                                                <TextBlock Text="{Binding MbCredits.Date}" Foreground="#888" FontSize="12"/>
                                            </StackPanel>
                                            <TextBlock Grid.Column="1" Text="ðŸ’¿" FontSize="24" VerticalAlignment="Center" Opacity="0.3"/>
                                        </Grid>
                                    </Border>

                                    <!-- Producers -->
                                    <StackPanel IsVisible="{Binding MbCredits.Producers.Count}">
                                        <TextBlock Text="PRODUCERS" FontSize="9" Foreground="#666" FontWeight="Bold" Margin="0,0,0,4"/>
                                        <ItemsControl ItemsSource="{Binding MbCredits.Producers}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" Foreground="#DDD" FontSize="12" Margin="0,0,0,2"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Mixers -->
                                    <StackPanel IsVisible="{Binding MbCredits.Mixers.Count}">
                                        <TextBlock Text="MIX / REMIX" FontSize="9" Foreground="#666" FontWeight="Bold" Margin="0,4,0,4"/>
                                        <ItemsControl ItemsSource="{Binding MbCredits.Mixers}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" Foreground="#DDD" FontSize="12" Margin="0,0,0,2"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Engineers -->
                                    <StackPanel IsVisible="{Binding MbCredits.Engineers.Count}">
                                        <TextBlock Text="ENGINEERING" FontSize="9" Foreground="#666" FontWeight="Bold" Margin="0,4,0,4"/>
                                        <ItemsControl ItemsSource="{Binding MbCredits.Engineers}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" Foreground="#DDD" FontSize="12" Margin="0,0,0,2"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </StackPanel>

                                <TextBlock Text="No deep credits found for this track." Foreground="#666" FontStyle="Italic" 
                                           HorizontalAlignment="Center" Margin="0,8"
                                           IsVisible="{Binding MbCredits, Converter={x:Static ObjectConverters.IsNull}}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- TAB 6: ANALYSIS HISTORY (Phase 21) -->
            <TabItem Header="Analysis History" FontSize="14" FontWeight="SemiBold">
                <ScrollViewer Margin="0,10,0,0">
                    <StackPanel Spacing="12">
                        <!-- Summary Header -->
                        <Border Background="#252526" CornerRadius="8" Padding="16">
                            <StackPanel Spacing="4">
                                <TextBlock Text="ANALYSIS RUN HISTORY" FontSize="12" Foreground="#AAA" FontWeight="Bold"/>
                                <TextBlock Text="Shows all analysis attempts for this track with status, performance, and error details." 
                                           FontSize="11" Foreground="#666" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- Runs List -->
                        <ItemsControl ItemsSource="{Binding AnalysisHistory}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#1E1E1E" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <Border Grid.Column="0" CornerRadius="4" Padding="6,2" VerticalAlignment="Center" Margin="0,0,12,0"
                                                    Tag="{Binding Status}">
                                                <Border.Styles>
                                                    <Style Selector="Border[Tag=Completed]">
                                                        <Setter Property="Background" Value="#1DB954"/>
                                                    </Style>
                                                    <Style Selector="Border[Tag=Failed]">
                                                        <Setter Property="Background" Value="#FF5252"/>
                                                    </Style>
                                                    <Style Selector="Border[Tag=Processing]">
                                                        <Setter Property="Background" Value="#2196F3"/>
                                                    </Style>
                                                    <Style Selector="Border[Tag=Queued]">
                                                        <Setter Property="Background" Value="#666666"/>
                                                    </Style>
                                                </Border.Styles>
                                                <TextBlock Text="{Binding Status}" Foreground="White" FontSize="10" FontWeight="Bold"/>
                                            </Border>
                                            
                                            <!-- Info -->
                                            <StackPanel Grid.Column="1" Spacing="4">
                                                <TextBlock Text="{Binding StartedAt, StringFormat='Started: {0:yyyy-MM-dd HH:mm:ss}'}" 
                                                           Foreground="#AAA" FontSize="11"/>
                                                <TextBlock Text="{Binding ErrorMessage, StringFormat='Error: {0}'}" 
                                                           Foreground="#FF5252" FontSize="11"
                                                           IsVisible="{Binding ErrorMessage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                                <StackPanel Orientation="Horizontal" Spacing="12">
                                                    <TextBlock Text="{Binding DurationMs, StringFormat='Total: {0}ms'}" 
                                                               Foreground="#666" FontSize="10"/>
                                                    <TextBlock Text="{Binding FfmpegDurationMs, StringFormat='FFmpeg: {0}ms'}" 
                                                               Foreground="#666" FontSize="10"/>
                                                    <TextBlock Text="{Binding EssentiaDurationMs, StringFormat='Essentia: {0}ms'}" 
                                                               Foreground="#666" FontSize="10"/>
                                                </StackPanel>
                                            </StackPanel>
                                            
                                            <!-- Checkmarks -->
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                <TextBlock Text="ðŸŒŠ" ToolTip.Tip="Waveform" IsVisible="{Binding WaveformGenerated}"/>
                                                <TextBlock Text="ðŸŽµ" ToolTip.Tip="FFmpeg" IsVisible="{Binding FfmpegAnalysisCompleted}"/>
                                                <TextBlock Text="ðŸ§ " ToolTip.Tip="Essentia" IsVisible="{Binding EssentiaAnalysisCompleted}"/>
                                                <TextBlock Text="ðŸ’¾" ToolTip.Tip="Database" IsVisible="{Binding DatabaseSaved}"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <!-- Empty State -->
                        <TextBlock Text="No analysis history found for this track" 
                                   Foreground="#666" FontStyle="Italic"
                                   HorizontalAlignment="Center" Margin="0,40"
                                   IsVisible="{Binding !AnalysisHistory.Count}"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Empty State -->
        <StackPanel Grid.Row="1" VerticalAlignment="Center" IsVisible="{Binding HasTrack, Converter={StaticResource BoolInverseConverter}}">
            <TextBlock Text="ðŸ”" FontSize="48" HorizontalAlignment="Center"/>
            <TextBlock Text="Select a track to inspect" FontSize="16" Foreground="#666" HorizontalAlignment="Center" Margin="0,16,0,0"/>
        </StackPanel>
        
        <!-- Progress Modal Overlay -->
        <ContentControl Grid.Row="0" Grid.RowSpan="2"
                        Content="{Binding ProgressModal}"
                        IsVisible="{Binding IsProgressModalVisible}">
            <ContentControl.ContentTemplate>
                <DataTemplate>
                    <controls:AnalysisProgressModal/>
                </DataTemplate>
            </ContentControl.ContentTemplate>
        </ContentControl>
    </Grid>
</UserControl>
